<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thomas-li-sjtu.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="RocketMQ 整理">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ">
<meta property="og:url" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/index.html">
<meta property="og:site_name" content="More Than Code">
<meta property="og:description" content="RocketMQ 整理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/解耦2.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/MQ比较.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/RocketMQ角色.jpg">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/RocketMQ集群.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/事务消息.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/消息存储方式.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%92%8C%E7%BD%91%E7%BB%9C%E6%93%8D%E4%BD%9C.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/消息存储结构.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/同步刷盘和异步刷盘.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/RocketMQ角色-1682761941955.jpg">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/消息发送高可用设计.jpg">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/producer负载均衡.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/consumer负载均衡.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/consumer负载均衡2.png">
<meta property="og:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/consumer负载均衡3.png">
<meta property="article:published_time" content="2023-04-15T09:13:33.000Z">
<meta property="article:modified_time" content="2023-05-03T04:34:27.519Z">
<meta property="article:author" content="Thomas-Li">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/解耦2.png">

<link rel="canonical" href="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>RocketMQ | More Than Code</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/thomas-li-sjtu" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">More Than Code</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Thomas-Li">
      <meta itemprop="description" content="Stay hungry. Stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="More Than Code">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RocketMQ
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-15 17:13:33" itemprop="dateCreated datePublished" datetime="2023-04-15T17:13:33+08:00">2023-04-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>36k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>33 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>RocketMQ 整理</p>
<a id="more"></a>

<h2 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h2><ul>
<li><p>先进先出</p>
</li>
<li><p>应用：</p>
<ul>
<li><p>应用解耦：下游系统故障时，向下游发送的数据被缓存到消息队列，对外接口正常返回。下游系统系统回复后，补充处理存在消息队列中的消息即可</p>
<p>队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。</p>
<img src="/2023/04/15/RocketMQ/解耦2.png" style="zoom:67%;">
</li>
<li><p>削峰：将大量请求缓存起来，分散到很长一段时间处理</p>
</li>
<li><p>数据分发：数据产生方不关心谁使用数据，只将数据发送到消息队列，使用方从消息队列直接获取数据即可</p>
</li>
</ul>
</li>
<li><p>缺点：</p>
<ul>
<li>可用性降低（外部依赖越多，稳定性越差）——<strong>如何保证MQ高可用？</strong></li>
<li>复杂度提高（从同步转为异步）——消息的顺序性？消息丢失怎么办？消息不被重复消费？</li>
<li>消息的一致性？——BC同时拉取数据，B成功执行，C执行失败，如何保证处理进度的一致性？</li>
</ul>
</li>
</ul>
<h3 id="主流MQ"><a href="#主流MQ" class="headerlink" title="主流MQ"></a>主流MQ</h3><img src="/2023/04/15/RocketMQ/MQ比较.png" style="zoom: 33%;">

<h2 id="单节点、集群搭建"><a href="#单节点、集群搭建" class="headerlink" title="单节点、集群搭建"></a>单节点、集群搭建</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.5.1/rocketmq-all-4.5.1-bin-release.zip">下载地址</a></li>
<li>目录结构：<ul>
<li>bin：启动脚本，包括shell脚本和CMD脚本</li>
<li>conf：实例配置文件 ，包括broker配置文件、logback配置文件</li>
<li>lib：依赖jar包，包括Netty、commons-lang、FastJSON等</li>
</ul>
</li>
</ul>
<h3 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.启动NameServer</span></span><br><span class="line">nohup sh bin/mqnamesrv &amp;</span><br><span class="line"><span class="comment"># 2.查看启动日志</span></span><br><span class="line">tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.启动Broker</span></span><br><span class="line">nohup sh bin/mqbroker -n localhost:9876 &amp;</span><br><span class="line"><span class="comment"># 2.查看启动日志</span></span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log </span><br></pre></td></tr></table></figure>

<ul>
<li><p>RocketMQ默认的虚拟机内存较大，可能需要修改JVM内存大小（runbroker.sh和runserver.sh中修改<code>JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m  -XX:MaxMetaspaceSize=320m&quot;</code>）</p>
</li>
<li><p>bash命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.设置环境变量</span></span><br><span class="line"><span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line"><span class="comment"># 2.发送消息</span></span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.接收消息</span></span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.关闭NameServer</span></span><br><span class="line">sh bin/mqshutdown namesrv</span><br><span class="line"><span class="comment"># 2.关闭Broker</span></span><br><span class="line">sh bin/mqshutdown broker</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><h4 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h4><ul>
<li><p>Producer：消息的发送者</p>
<ul>
<li>Producer与NameServer集群中的任意节点建立长连接，定期从NameServer取Topic路由信息</li>
<li>Producer向提供Topic服务的Master Broker建立长连接，定时向Master发送心跳</li>
<li>Producer完全无状态，可集群部署</li>
</ul>
</li>
<li><p>Consumer：消息接收者</p>
<ul>
<li>Consumer与NameServer集群中的任意节点建立长连接，定期从NameServer取Topic路由信息</li>
<li>Consumer向提供Topic服务的Master Broker、Slave Broker建立长连接，定时向Master、Slave发送心跳</li>
<li>Consumer既可以从Master订阅消息，也可以从Slave订阅消息</li>
<li>一个消费者只可以订阅和消费一种Topic的消息</li>
</ul>
</li>
<li><p>Broker：暂存和传输消息</p>
<ul>
<li>分为Master与Slave，Master与Slave的对应关系通过指定相同的BrokerName，不同的BrokerId定义</li>
<li>BrokerId为0表示Master，非0表示Slave</li>
<li>Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer</li>
</ul>
</li>
<li><p>NameServer：管理Broker</p>
<ul>
<li>几乎无状态节点，可集群部署，<strong>节点之间无任何信息同步</strong></li>
</ul>
</li>
<li><p>Topic：区分消息的种类；一个发送者可以发送消息给一个或者多个Topic；一个消息的接收者可以订阅一个或者多个Topic</p>
</li>
<li><p>Message Queue：Topic的分区；用于并行发送和接收消息</p>
</li>
<li><p>Tag：为消息设置的Tag，用于同一主题下区分不同类型的消息。 来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性</p>
</li>
<li><p>GroupName：</p>
<ul>
<li><p>在集群的情况下，一个生产者down之后，可以继续联系该组下的另外一个生产者实例，不至于导致业务走不下去。在消费者组中，可以实现消息消费的负载均衡和消息容错目标</p>
</li>
<li><p>有了GroupName，在集群下，只需要在新加的机器中，配置相同的GroupName。启动后，能加入到所在的群组中，参与消息生产或消费</p>
</li>
<li><p>同一个消费者组下的消费者，不能同时消费同一个queue</p>
</li>
<li><p>一个节点下，一个topic加一个tag可以对应一个consumer。一个消费者组就是横向上多个节点的相同consumer为一个消费组</p>
</li>
</ul>
<img src="/2023/04/15/RocketMQ/RocketMQ角色.jpg" style="zoom: 50%;">

</li>
</ul>
<h4 id="搭建方式"><a href="#搭建方式" class="headerlink" title="搭建方式"></a>搭建方式</h4><ul>
<li><p>单Master：只有一个Broker存储消息</p>
</li>
<li><p>多Master：多个Broker存储消息</p>
<ul>
<li>单一个Broker宕机时未消费的消息</li>
<li>磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高</li>
</ul>
</li>
<li><p>多Master多Slave</p>
<ul>
<li>异步：异步复制，主备有短暂消息延迟（毫秒级）；性能同多Master模式几乎一样；Master宕机，磁盘损坏情况下会丢失少量消息</li>
<li>同步：只有主备都写成功，才向应用返回成功；服务可用性与数据可用性都非常高；性能比异步复制模式略低</li>
</ul>
</li>
<li><p>（同步双写）搭建</p>
<img src="/2023/04/15/RocketMQ/RocketMQ集群.png" style="zoom: 67%;">

<ul>
<li>工作流程：<ul>
<li>启动NameServer，NameServer监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心</li>
<li>Broker启动，与所有NameServer保持长连接，定时发送心跳——心跳包含当前Broker信息（IP+端口等）以及存储的Topic信息。注册成功后，NameServer集群记录Topic跟Broker的映射关系</li>
<li>收发消息前，创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic</li>
<li>Producer发送消息，启动时与一个NameServer建立长连接，从NameServer获取Topic所在的Broker列表，与一个Broker建立长连接从而向Broker发消息</li>
<li>Consumer与一台NameServer建立长连接，获取Topic和Broker的映射，直接跟Broker建立连接通道，开始消费消息</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Broker配置"><a href="#Broker配置" class="headerlink" title="Broker配置"></a>Broker配置</h4><h5 id="1）master1"><a href="#1）master1" class="headerlink" title="1）master1"></a>1）master1</h5><p>服务器：192.168.25.135</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-a.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-a</span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=0</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=10911</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure>

<h5 id="2）slave2"><a href="#2）slave2" class="headerlink" title="2）slave2"></a>2）slave2</h5><p>服务器：192.168.25.135</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-b-s.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-b</span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=1</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=11011</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SLAVE</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure>

<h5 id="3）master2"><a href="#3）master2" class="headerlink" title="3）master2"></a>3）master2</h5><p>服务器：192.168.25.138</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-b.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-b</span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=0</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=10911</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure>

<h5 id="4）slave1"><a href="#4）slave1" class="headerlink" title="4）slave1"></a>4）slave1</h5><p>服务器：192.168.25.138</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-a-s.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-a</span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=1</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=11011</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SLAVE</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure>

<h3 id="mqadmin管理工具"><a href="#mqadmin管理工具" class="headerlink" title="mqadmin管理工具"></a>mqadmin管理工具</h3><ul>
<li>进入RocketMQ，bin目录下执行<code>./mqadmin &#123;command&#125; &#123;args&#125;</code> </li>
</ul>
<h4 id="1）Topic相关"><a href="#1）Topic相关" class="headerlink" title="1）Topic相关"></a>1）Topic相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td rowspan="8" height="593" class="xl68" width="163" style="border-bottom:1.0pt;
  height:444.0pt;border-top:none;width:122pt">updateTopic</td>
  <td rowspan="8" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">创建更新Topic配置</td>
  <td class="xl65" width="149" style="width:112pt">-b</td>
  <td class="xl66" width="159" style="width:119pt">Broker 地址，表示 topic 所在
  Broker，只支持单台Broker，地址为ip:port</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td height="132" class="xl65" width="149" style="height:99.0pt;width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">cluster 名称，表示 topic 所在集群（集群可通过
  clusterList 查询）</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h-</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer服务地址，格式 ip:port</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl65" width="149" style="height:57.0pt;width:112pt">-p</td>
  <td class="xl66" width="159" style="width:119pt">指定新topic的读写权限( W=2|R=4|WR=6 )</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-r</td>
  <td class="xl66" width="159" style="width:119pt">可读队列数（默认为 8）</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-w</td>
  <td class="xl66" width="159" style="width:119pt">可写队列数（默认为 8）</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td height="95" class="xl65" width="149" style="height:71.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称（名称只能使用字符
  ^[a-zA-Z0-9_-]+$ ）</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td rowspan="4" height="307" class="xl68" width="163" style="border-bottom:1.0pt;
  height:230.0pt;border-top:none;width:122pt">deleteTopic</td>
  <td rowspan="4" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">删除Topic</td>
  <td class="xl65" width="149" style="width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">cluster 名称，表示删除某集群下的某个 topic （集群
  可通过 clusterList 查询）</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td height="95" class="xl65" width="149" style="height:71.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称（名称只能使用字符
  ^[a-zA-Z0-9_-]+$ ）</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="287" class="xl68" width="163" style="border-bottom:1.0pt;
  height:215.0pt;border-top:none;width:122pt">topicList</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 列表信息</td>
  <td class="xl65" width="149" style="width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td height="207" class="xl65" width="149" style="height:155.0pt;width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">不配置-c只返回topic列表，增加-c返回clusterName,
  topic, consumerGroup信息，即topic的所属集群和订阅关系，没有参数</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="103" class="xl68" width="163" style="border-bottom:1.0pt;
  height:77.0pt;border-top:none;width:122pt">topicRoute</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 路由信息</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="103" class="xl68" width="163" style="border-bottom:1.0pt;
  height:77.0pt;border-top:none;width:122pt">topicStatus</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 消息队列offset</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="103" class="xl68" width="163" style="border-bottom:1.0pt;
  height:77.0pt;border-top:none;width:122pt">topicClusterList</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 所在集群列表</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="6" height="518" class="xl68" width="163" style="border-bottom:1.0pt;
  height:380pt;border-top:none;width:122pt">updateTopicPerm</td>
  <td rowspan="6" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">更新 Topic 读写权限</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td height="132" class="xl65" width="149" style="height:99.0pt;width:112pt">-b</td>
  <td class="xl66" width="159" style="width:119pt">Broker 地址，表示 topic 所在
  Broker，只支持单台Broker，地址为ip:port</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl65" width="149" style="height:57.0pt;width:112pt">-p</td>
  <td class="xl66" width="159" style="width:119pt">指定新 topic 的读写权限( W=2|R=4|WR=6 )</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td height="207" class="xl65" width="149" style="height:155.0pt;width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">cluster 名称，表示 topic 所在集群（集群可通过
  clusterList 查询），-b优先，如果没有-b，则对集群中所有Broker执行命令</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="5" height="199" class="xl68" width="163" style="border-bottom:1.0pt;
  height:149.0pt;border-top:none;width:122pt">updateOrderConf</td>
  <td rowspan="5" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td>
  <td class="xl65" width="149" style="width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic，键</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-v</td>
  <td class="xl66" width="159" style="width:119pt">orderConf，值</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-m</td>
  <td class="xl66" width="159" style="width:119pt">method，可选get、put、delete</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="198" class="xl68" width="163" style="border-bottom:1.0pt;
  height:140pt;border-top:none;width:122pt">allocateMQ</td>
  <td rowspan="4" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">以平均负载算法计算消费者列表负载消息队列的负载结果</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td height="95" class="xl65" width="149" style="height:71.0pt;width:112pt">-i</td>
  <td class="xl66" width="159" style="width:119pt">ipList，用逗号分隔，计算这些ip去负载Topic的消息队列</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="142" class="xl68" width="163" style="border-bottom:1.0pt solid black;
  height:106.0pt;border-top:1.0pt;width:122pt">statsAll</td>
  <td rowspan="4" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td>
  <td class="xl65" width="149" style="width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-a</td>
  <td class="xl66" width="159" style="width:119pt">是否只打印活跃topic</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">指定topic</td>
 </tr>
</table>

<h4 id="2）集群相关"><a href="#2）集群相关" class="headerlink" title="2）集群相关"></a>2）集群相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td rowspan="4" height="326" class="xl67" width="177" style="border-bottom:1.0pt;
  height:244.0pt;border-top:none;width:133pt"><span style="mso-spacerun:yes"> </span>clusterList</td>
  <td rowspan="4" class="xl70" width="175" style="border-bottom:1.0pt;
  border-top:none;width:131pt">查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td>
  <td class="xl65" width="177" style="width:133pt">-m</td>
  <td class="xl66" width="185" style="width:139pt">打印更多信息 (增加打印出如下信息 #InTotalYest,
  #OutTotalYest, #InTotalToday ,#OutTotalToday)</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="177" style="height:17.0pt;width:133pt">-h</td>
  <td class="xl66" width="185" style="width:139pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="177" style="height:43.0pt;width:133pt">-n</td>
  <td class="xl66" width="185" style="width:139pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-i</td>
  <td class="xl66" width="185" style="width:139pt">打印间隔，单位秒</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td rowspan="8" height="391" class="xl67" width="177" style="border-bottom:1.0pt;
  height:292.0pt;border-top:none;width:133pt">clusterRT</td>
  <td rowspan="8" class="xl70" width="175" style="border-bottom:1.0pt;
  border-top:none;width:131pt">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td>
  <td class="xl65" width="177" style="width:133pt">-a</td>
  <td class="xl66" width="185" style="width:139pt">amount，每次探测的总数，RT = 总时间 /
  amount</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-s</td>
  <td class="xl66" width="185" style="width:139pt">消息大小，单位B</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="177" style="height:17.0pt;width:133pt">-c</td>
  <td class="xl66" width="185" style="width:139pt">探测哪个集群</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl65" width="177" style="height:57.0pt;width:133pt">-p</td>
  <td class="xl66" width="185" style="width:139pt">是否打印格式化日志，以|分割，默认不打印</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="177" style="height:17.0pt;width:133pt">-h</td>
  <td class="xl66" width="185" style="width:139pt">打印帮助</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-m</td>
  <td class="xl66" width="185" style="width:139pt">所属机房，打印使用</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-i</td>
  <td class="xl66" width="185" style="width:139pt">发送间隔，单位秒</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="177" style="height:43.0pt;width:133pt">-n</td>
  <td class="xl66" width="185" style="width:139pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
</table>

<h4 id="3）Broker相关"><a href="#3）Broker相关" class="headerlink" title="3）Broker相关"></a>3）Broker相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="6" height="206" class="xl69" width="191" style="border-bottom:1.0pt;
  height:154.0pt;border-top:none;width:143pt">updateBrokerConfig</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">更新 Broker 配置文件，会修改Broker.conf</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，格式为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">cluster 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl68" width="87" style="width:65pt">key 值</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-v</td>
  <td class="xl68" width="87" style="width:65pt">value 值</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="3" height="137" class="xl69" width="191" style="border-bottom:1.0pt;
  height:103.0pt;border-top:none;width:143pt">brokerStatus</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">查看 Broker 统计信息、运行状态（你想要的信息几乎都在里面）</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="6" height="256" class="xl69" width="191" style="border-bottom:1.0pt;
  height:192.0pt;border-top:none;width:143pt">brokerConsumeStats</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">Broker中各个消费者的消费情况，按Message Queue维度返回Consume
  Offset，Broker Offset，Diff，TImestamp等信息</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">请求超时时间</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-l</td>
  <td class="xl68" width="87" style="width:65pt">diff阈值，超过阈值才打印</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">是否为顺序topic，一般为false</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="2" height="114" class="xl69" width="191" style="border-bottom:1.0pt;
  height:86.0pt;border-top:none;width:143pt">getBrokerConfig</td>
  <td rowspan="2" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">获取Broker配置</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="3" height="137" class="xl69" width="191" style="border-bottom:1.0pt;
  height:103.0pt;border-top:none;width:143pt">wipeWritePerm</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">从NameServer上清除 Broker写权限</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="4" height="160" class="xl69" width="191" style="border-bottom:1.0pt;
  height:120.0pt;border-top:none;width:143pt">cleanExpiredCQ</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="88" style="mso-height-source:userset;height:66.0pt">
  <td rowspan="4" height="191" class="xl69" width="191" style="border-bottom:1.0pt;
  height:143.0pt;border-top:none;width:143pt">cleanUnusedTopic</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">清理Broker上不使用的Topic，从内存中释放Topic的Consume
  Queue，如果手动删除Topic会产生不使用的Topic</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="5" height="199" class="xl69" width="191" style="border-bottom:1.0pt;
  height:149.0pt;border-top:none;width:143pt">sendMsgStatus</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">向Broker发消息，返回发送状态和RT</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">BrokerName，注意不同于Broker地址</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">消息大小，单位B</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">发送次数</td>
 </tr>
</table>

<h4 id="4）消息相关"><a href="#4）消息相关" class="headerlink" title="4）消息相关"></a>4）消息相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
<tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="128" style="height:96.0pt">
  <td rowspan="3" height="208" class="xl69" width="87" style="border-bottom:1.0pt;
  height:156.0pt;border-top:none;width:65pt">queryMsgById</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据offsetMsgId查询msg，如果使用开源控制台，应使用offsetMsgId，此命令还有其他参数，具体作用请阅读QueryMsgByIdSubCommand。</td>
  <td class="xl67" width="87" style="width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">msgId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="126" class="xl69" width="87" style="border-bottom:1.0pt;
  height:94.0pt;border-top:none;width:65pt">queryMsgByKey</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据消息 Key 查询消息</td>
  <td class="xl67" width="87" style="width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">msgKey</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">Topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="225" style="height:169.0pt">
  <td rowspan="6" height="390" class="xl69" width="87" style="border-bottom:1.0pt;
  height:292.0pt;border-top:none;width:65pt">queryMsgByOffset</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据 Offset 查询消息</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 名称，（这里需要注意
  填写的是 Broker 的名称，不是 Broker 的地址，Broker 名称可以在 clusterList 查到）</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-i</td>
  <td class="xl68" width="87" style="width:65pt">query 队列 id</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">offset 值</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="47">
  <td rowspan="6" height="209" class="xl69" width="87" style="border-bottom:1.0pt;
  height:156.0pt;border-top:none;width:65pt">queryMsgByUniqueKey</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">uniqe msg id</td>
 </tr>
 <tr height="36" style="height:27.0pt">
  <td height="36" class="xl67" width="87" style="height:27.0pt;width:65pt">-g</td>
  <td class="xl67" width="87" style="width:65pt">consumerGroup</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-d</td>
  <td class="xl67" width="87" style="width:65pt">clientId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="5" height="149" class="xl69" width="87" style="border-bottom:1.0pt
  height:111.0pt;border-top:none;width:65pt">checkMsgSendRT</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">检测向topic发消息的RT，功能类似clusterRT</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-a</td>
  <td class="xl68" width="87" style="width:65pt">探测次数</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">消息大小</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="8" height="218" class="xl69" width="87" style="border-bottom:1.0pt;
  height:162.0pt;border-top:none;width:65pt">sendMessage</td>
  <td rowspan="8" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-p</td>
  <td class="xl68" width="87" style="width:65pt">body，消息体</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">keys</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl67" width="87" style="width:65pt">tags</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl67" width="87" style="width:65pt">BrokerName</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">queueId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="10" height="312" class="xl69" width="87" style="border-bottom:1.0pt;
  height:232.0pt;border-top:none;width:65pt">consumeMessage</td>
  <td rowspan="10" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl67" width="87" style="width:65pt">BrokerName</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">从offset开始消费</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">queueId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">开始时间戳，格式详见-h</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">结束时间戳</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">消费多少条消息</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="8" height="282" class="xl69" width="87" style="border-bottom:1.0pt;
  height:210.0pt;border-top:none;width:65pt">printMsg</td>
  <td rowspan="8" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">从Broker消费消息并打印，可选时间段</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">字符集，例如UTF-8</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">subExpress，过滤表达式</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">开始时间戳，格式参见-h</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-e</td>
  <td class="xl68" width="87" style="width:65pt">结束时间戳</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">是否打印消息体</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="12" height="390" class="xl69" width="87" style="border-bottom:1.0pt;
  height:290.0pt;border-top:none;width:65pt">printMsgByQueue</td>
  <td rowspan="12" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">类似printMsg，但指定Message Queue</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">queueId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-a</td>
  <td class="xl67" width="87" style="width:65pt">BrokerName</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">字符集，例如UTF-8</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">subExpress，过滤表达式</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">开始时间戳，格式参见-h</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-e</td>
  <td class="xl68" width="87" style="width:65pt">结束时间戳</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-p</td>
  <td class="xl68" width="87" style="width:65pt">是否打印消息</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">是否打印消息体</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-f</td>
  <td class="xl68" width="87" style="width:65pt">是否统计tag数量并打印</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="7" height="410" class="xl69" width="87" style="border-bottom:1.0pt;
  height:307.0pt;border-top:none;width:65pt">resetOffsetByTime</td>
  <td rowspan="7" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">按时间戳重置offset，Broker和consumer都会重置</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">重置为此时间戳对应的offset</td>
 </tr>
 <tr height="188" style="height:141.0pt">
  <td height="188" class="xl67" width="87" style="height:141.0pt;width:65pt">-f</td>
  <td class="xl68" width="87" style="width:65pt">是否强制重置，如果false，只支持回溯offset，如果true，不管时间戳对应offset与consumeOffset关系</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">是否重置c++客户端offset</td>
 </tr>
</table>


<h4 id="5）消费者、消费组相关"><a href="#5）消费者、消费组相关" class="headerlink" title="5）消费者、消费组相关"></a>5）消费者、消费组相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
<tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="4" height="158" class="xl69" width="87" style="border-bottom:1.0pt;
  height:110pt;border-top:none;width:65pt">consumerProgress</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">查看订阅组消费状态，可以查看具体的client IP的消息积累量</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者所属组名</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">是否打印client IP</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="105" style="mso-height-source:userset;height:79.0pt">
  <td rowspan="5" height="260" class="xl69" width="87" style="border-bottom:1.0pt;
  height:195.0pt;border-top:none;width:65pt">consumerStatus</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process
  Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="36" style="height:27.0pt">
  <td height="36" class="xl67" width="87" style="height:27.0pt;width:65pt">-g</td>
  <td class="xl67" width="87" style="width:65pt">consumer group</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">clientId</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">是否执行jstack</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="5" height="181" class="xl69" width="87" style="border-bottom:1.0pt
  height:135.0pt;border-top:none;width:65pt">getConsumerStatus</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">获取 Consumer 消费进度</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者所属组名</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">查询主题</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-i</td>
  <td class="xl68" width="87" style="width:65pt">Consumer 客户端 ip</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="13" height="761" class="xl69" width="87" style="border-bottom:1.0pt
  height:569.0pt;border-top:none;width:65pt">updateSubGroup</td>
  <td rowspan="13" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">更新或创建订阅关系</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker地址</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">分组是否允许消费</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-m</td>
  <td class="xl68" width="87" style="width:65pt">是否从最小offset开始消费</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">是否是广播模式</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-q</td>
  <td class="xl68" width="87" style="width:65pt">重试队列数量</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-r</td>
  <td class="xl68" width="87" style="width:65pt">最大重试次数</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td height="207" class="xl67" width="87" style="height:155.0pt;width:65pt">-i</td>
  <td class="xl68" width="87" style="width:65pt">当slaveReadEnable开启时有效，且还未达到从slave消费时建议从哪个BrokerId消费，可以配置备机id，主动从备机消费</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td height="132" class="xl67" width="87" style="height:99.0pt;width:65pt">-w</td>
  <td class="xl68" width="87" style="width:65pt">如果Broker建议从slave消费，配置决定从哪个slave消费，配置BrokerId，例如1</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl67" width="87" style="height:57.0pt;width:65pt">-a</td>
  <td class="xl68" width="87" style="width:65pt">当消费者数量变化时是否通知其他消费者负载均衡</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="5" height="165" class="xl69" width="87" style="border-bottom:1.0pt
  height:123.0pt;border-top:none;width:65pt">deleteSubGroup</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">从Broker删除订阅关系</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker地址</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="6" height="172" class="xl69" width="87" style="border-bottom:1.0pt
  height:120pt;border-top:none;width:65pt">cloneGroupOffset</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">在目标群组中使用源群组的offset</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">源消费者组</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">目标消费者组</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">暂未使用</td>
 </tr>
</table>


<h4 id="6）连接相关"><a href="#6）连接相关" class="headerlink" title="6）连接相关"></a>6）连接相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
<tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="3" height="119" class="xl69" width="87" style="border-bottom:1.0pt
  height:89.0pt;border-top:none;width:65pt">consumerConnec tion</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">查询 Consumer 的网络连接</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者所属组名</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="4" height="142" class="xl69" width="87" style="border-bottom:1.0pt
  height:106.0pt;border-top:none;width:65pt">producerConnec tion</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">查询 Producer 的网络连接</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">生产者所属组名</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">主题名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
</table>


<h4 id="7）NameServer相关"><a href="#7）NameServer相关" class="headerlink" title="7）NameServer相关"></a>7）NameServer相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
<tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="21" style="height:16.0pt">
  <td rowspan="5" height="143" class="xl69" width="87" style="border-bottom:1.0pt
  height:100pt;border-top:none;width:65pt">updateKvConfig</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">更新NameServer的kv配置，目前还未使用</td>
  <td class="xl75" width="87" style="width:65pt">-s</td>
  <td class="xl76" width="87" style="width:65pt">命名空间</td>
 </tr>
 <tr height="21" style="height:16.0pt">
  <td height="21" class="xl75" width="87" style="height:16.0pt;width:65pt">-k</td>
  <td class="xl75" width="87" style="width:65pt">key</td>
 </tr>
 <tr height="21" style="height:16.0pt">
  <td height="21" class="xl75" width="87" style="height:16.0pt;width:65pt">-v</td>
  <td class="xl75" width="87" style="width:65pt">value</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="126" class="xl69" width="87" style="border-bottom:1.0pt
  height:94.0pt;border-top:none;width:65pt">deleteKvConfig</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">删除NameServer的kv配置</td>
  <td class="xl67" width="87" style="width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">命名空间</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">key</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="2" height="80" class="xl69" width="87" style="border-bottom:1.0pt
  height:60.0pt;border-top:none;width:65pt">getNamesrvConfig</td>
  <td rowspan="2" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">获取NameServer配置</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="4" height="126" class="xl69" width="87" style="border-bottom:1.0pt
  height:94.0pt;border-top:none;width:65pt">updateNamesrvConfig</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">修改NameServer配置</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">key</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-v</td>
  <td class="xl67" width="87" style="width:65pt">value</td>
 </tr>
</table>

<h2 id="消息发送消费范例"><a href="#消息发送消费范例" class="headerlink" title="消息发送消费范例"></a>消息发送消费范例</h2><ul>
<li>MQ客户端依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>发送者</p>
<ol>
<li>创建消息生产者producer，制定生产者组名</li>
<li>指定Nameserver地址</li>
<li>启动producer</li>
<li>创建消息对象，指定主题Topic、Tag和消息体</li>
<li>发送消息</li>
<li>关闭生产者</li>
</ol>
</li>
<li><p>消费者</p>
<ol>
<li>创建消费者Consumer，制定消费者组名</li>
<li>指定Nameserver地址</li>
<li>订阅主题Topic和Tag</li>
<li>设置回调函数，处理消息</li>
<li>启动消费者</li>
</ol>
</li>
</ul>
<h3 id="基本范例"><a href="#基本范例" class="headerlink" title="基本范例"></a>基本范例</h3><h4 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h4><ul>
<li><p>发送同步消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncProducer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">    	producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    	    <span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">    	    Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;TopicTest&quot;</span>, <span class="comment">/* Topic */</span></span><br><span class="line">        		<span class="string">&quot;TagA&quot;</span>,  <span class="comment">/* Tag */</span></span><br><span class="line">        		(<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)  <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">        	<span class="comment">// 发送消息到一个Broker</span></span><br><span class="line">            SendResult sendResult = producer.send(msg);</span><br><span class="line">            <span class="comment">// 通过sendResult返回消息是否成功送达</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送异步消息：异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncProducer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">            	<span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">// SendCallback接收异步返回结果的回调</span></span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(SendResult sendResult)</span> </span>&#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d OK %s %n&quot;</span>, index, sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">      	              System.out.printf(<span class="string">&quot;%-10d Exception %s %n&quot;</span>, index, e);</span><br><span class="line">      	              e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">            	&#125;);</span><br><span class="line">    	&#125;</span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送单向消息：主要用在不特别关心发送结果的场景，例如日志发送</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnewayProducer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        	Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)</span><br><span class="line">        	);</span><br><span class="line">        	<span class="comment">// 发送单向消息，没有任何返回结果</span></span><br><span class="line">        	producer.sendOneway(msg);</span><br><span class="line">    	&#125;</span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="消息消费"><a href="#消息消费" class="headerlink" title="消息消费"></a>消息消费</h4><ul>
<li><p>DefaultMQPushConsumer：系统控制读取操作，系统会自动根据用户设置参数进行消息处理，自动保存Offset、做负载均衡等</p>
</li>
<li><p>DefaultMQPullConsumer：使用者自主控制读取操作</p>
</li>
<li><p>负载均衡模式：多个消费者共同消费队列消息，每个消费者处理的消息不同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化消息生产者,指定组名</span></span><br><span class="line">    DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">&quot;group1&quot;</span>);</span><br><span class="line">    <span class="comment">// 指定Namesrv地址信息.</span></span><br><span class="line">    consumer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    <span class="comment">// 订阅Topic</span></span><br><span class="line">    consumer.subscribe(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">//负载均衡模式消费</span></span><br><span class="line">    consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class="line">    <span class="comment">// 注册回调函数，处理消息</span></span><br><span class="line">    consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//启动消费者</span></span><br><span class="line">    consumer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>广播模式：消费者采用广播的方式消费消息，每个消费者消费的消息都是相同的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">&quot;group1&quot;</span>);</span><br><span class="line">    consumer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    consumer.subscribe(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">//广播模式消费</span></span><br><span class="line">    consumer.setMessageModel(MessageModel.BROADCASTING);</span><br><span class="line">    <span class="comment">// 注册回调函数，处理消息</span></span><br><span class="line">    consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    consumer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h3><ul>
<li><p>按照消息的发送顺序来消费(FIFO)——RocketMQ可以保证消息有序，分为分区有序、全局有序</p>
</li>
<li><p>原理：默认情况下，采取Round Robin轮询方式把消息发送到不同的queue（分区队列），消费时从多个queue拉取消息。如果控制发送的消息只依次发送到同一个queue中，并只从这个queue上依次拉取消费，则为全局有序，否则为分区有序——相对每个queue消息都是有序的</p>
</li>
<li><p>分区有序的示例：订单号相同的消息会被先后发送到同一个队列中，消费时，同一个OrderId获取到的肯定是同一个队列</p>
</li>
<li><p>消息生产</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">       producer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">       producer.start();</span><br><span class="line"></span><br><span class="line">       String[] tags = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;TagC&quot;</span>, <span class="string">&quot;TagD&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单列表</span></span><br><span class="line">       List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> Producer().buildOrders();</span><br><span class="line"></span><br><span class="line">       Date date = <span class="keyword">new</span> Date();</span><br><span class="line">       String dateStr = SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(date);</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">           String body = dateStr + <span class="string">&quot; Hello RocketMQ &quot;</span> + orderList.get(i);</span><br><span class="line">           Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;TopicTest&quot;</span>, tags[i % tags.length], <span class="string">&quot;KEY&quot;</span> + i, body.getBytes());</span><br><span class="line"></span><br><span class="line">           SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</span><br><span class="line">                   Long id = (Long) arg;  <span class="comment">//根据订单id选择发送queue</span></span><br><span class="line">                   <span class="keyword">long</span> index = id % mqs.size();</span><br><span class="line">                   <span class="keyword">return</span> mqs.get((<span class="keyword">int</span>) index);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;, orderList.get(i).getOrderId()); <span class="comment">//订单id，即为arg</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       producer.shutdown();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">long</span> orderId;</span><br><span class="line">       <span class="keyword">private</span> String desc;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> List&lt;OrderStep&gt; <span class="title">buildOrders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> ArrayList&lt;OrderStep&gt;();</span><br><span class="line"></span><br><span class="line">       OrderStep orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;创建&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;创建&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;付款&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;付款&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;完成&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;推送&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">&quot;完成&quot;</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> orderList;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>顺序消费消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerInOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       DefaultMQPushConsumer consumer = <span class="keyword">new</span>            DefaultMQPushConsumer(<span class="string">&quot;please_rename_unique_group_name_3&quot;</span>);</span><br><span class="line">       consumer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span></span><br><span class="line"><span class="comment">        * 如果非第一次启动，那么按照上次消费的位置继续消费</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line">       consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;TagA || TagC || TagD&quot;</span>);</span><br><span class="line"></span><br><span class="line">       consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerOrderly() &#123;</span><br><span class="line">           Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> ConsumeOrderlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context)</span> </span>&#123;</span><br><span class="line">               context.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">               <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                   <span class="comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span></span><br><span class="line">                   System.out.println(<span class="string">&quot;consumeThread=&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;queueId=&quot;</span> + msg.getQueueId() + <span class="string">&quot;, content:&quot;</span> + <span class="keyword">new</span> String(msg.getBody()));</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//模拟业务逻辑处理中...</span></span><br><span class="line">                   TimeUnit.SECONDS.sleep(random.nextInt(<span class="number">10</span>));</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       consumer.start();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="延时消息"><a href="#延时消息" class="headerlink" title="延时消息"></a>延时消息</h3><ul>
<li><p>例如，提交一个订单就可以发送一个延时消息，1h后检查订单的状态，如果未付款就取消订单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledMessageConsumer</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">&quot;ExampleConsumer&quot;</span>);</span><br><span class="line">      consumer.subscribe(<span class="string">&quot;TestTopic&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">      <span class="comment">// 注册消息监听</span></span><br><span class="line">      consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; messages, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">for</span> (MessageExt message : messages) &#123;</span><br><span class="line">                  <span class="comment">// Print approximate delay time period</span></span><br><span class="line">                  System.out.println(<span class="string">&quot;Receive message[msgId=&quot;</span> + message.getMsgId() + <span class="string">&quot;] &quot;</span> + (System.currentTimeMillis() - message.getStoreTimestamp()) + <span class="string">&quot;ms later&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      consumer.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledMessageProducer</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// 实例化一个生产者来产生延时消息</span></span><br><span class="line">      DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">      producer.start();</span><br><span class="line">      <span class="keyword">int</span> totalMessagesToSend = <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; totalMessagesToSend; i++) &#123;</span><br><span class="line">          Message message = <span class="keyword">new</span> Message(<span class="string">&quot;TestTopic&quot;</span>, (<span class="string">&quot;Hello scheduled message &quot;</span> + i).getBytes());</span><br><span class="line">          <span class="comment">// 设置延时等级3,这个消息将在10s之后发送(现在只支持固定的几个时间,详看delayTimeLevel)</span></span><br><span class="line">          message.setDelayTimeLevel(<span class="number">3</span>);</span><br><span class="line">          <span class="comment">// 发送消息</span></span><br><span class="line">          producer.send(message);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">// 关闭生产者</span></span><br><span class="line">      producer.shutdown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>限制：现在RocketMq并不支持任意时间的延时，需要设置几个固定的延时等级，从1s到2h分别对应着等级1到18</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/rocketmq/store/config/MessageStoreConfig.java</span></span><br><span class="line"><span class="keyword">private</span> String messageDelayLevel = <span class="string">&quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;</span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="批量消息"><a href="#批量消息" class="headerlink" title="批量消息"></a>批量消息</h3><ul>
<li><p>批量发送消息显著提高传递小消息的性能，但这些批量消息有相同的topic，相同的waitStoreMsgOK，不能是延时消息，总大小不应超过4MB（超过则需要分割消息）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">String topic = <span class="string">&quot;BatchTest&quot;</span>;</span><br><span class="line">List&lt;Message&gt; messages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">messages.add(<span class="keyword">new</span> Message(topic, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID001&quot;</span>, <span class="string">&quot;Hello world 0&quot;</span>.getBytes()));</span><br><span class="line">messages.add(<span class="keyword">new</span> Message(topic, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID002&quot;</span>, <span class="string">&quot;Hello world 1&quot;</span>.getBytes()));</span><br><span class="line">messages.add(<span class="keyword">new</span> Message(topic, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID003&quot;</span>, <span class="string">&quot;Hello world 2&quot;</span>.getBytes()));</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   producer.send(messages);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分割消息</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListSplitter</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">List</span>&lt;<span class="title">Message</span>&gt;&gt; </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE_LIMIT = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Message&gt; messages;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> currIndex;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ListSplitter</span><span class="params">(List&lt;Message&gt; messages)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.messages = messages;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> currIndex &lt; messages.size();</span><br><span class="line">   &#125;</span><br><span class="line">   	<span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Message&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> nextIndex = currIndex;</span><br><span class="line">       <span class="keyword">int</span> totalSize = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (; nextIndex &lt; messages.size(); nextIndex++) &#123;</span><br><span class="line">           Message message = messages.get(nextIndex);</span><br><span class="line">           <span class="keyword">int</span> tmpSize = message.getTopic().length() + message.getBody().length;</span><br><span class="line">           Map&lt;String, String&gt; properties = message.getProperties();</span><br><span class="line">           <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">               tmpSize += entry.getKey().length() + entry.getValue().length();</span><br><span class="line">           &#125;</span><br><span class="line">           tmpSize = tmpSize + <span class="number">20</span>; <span class="comment">// 增加日志的开销20字节</span></span><br><span class="line">           <span class="keyword">if</span> (tmpSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">               <span class="comment">//单个消息超过了最大的限制</span></span><br><span class="line">               <span class="comment">//忽略,否则会阻塞分裂的进程</span></span><br><span class="line">               <span class="keyword">if</span> (nextIndex - currIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="comment">//假如下一个子列表没有元素,则添加这个子列表然后退出循环,否则只是退出循环</span></span><br><span class="line">                  nextIndex++;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (tmpSize + totalSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               totalSize += tmpSize;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       List&lt;Message&gt; subList = messages.subList(currIndex, nextIndex);</span><br><span class="line">       currIndex = nextIndex;</span><br><span class="line">       <span class="keyword">return</span> subList;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把大的消息分裂成若干个小的消息</span></span><br><span class="line">ListSplitter splitter = <span class="keyword">new</span> ListSplitter(messages);</span><br><span class="line"><span class="keyword">while</span> (splitter.hasNext()) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;Message&gt; listItem = splitter.next();</span><br><span class="line">      producer.send(listItem);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="过滤消息"><a href="#过滤消息" class="headerlink" title="过滤消息"></a>过滤消息</h3><ul>
<li>可以根据tag来过滤消息，如下所示，消费者将消费TAGA或TAGB或TAGC的消息，但一个消息只能有一个标签</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">&quot;CID_EXAMPLE&quot;</span>);</span><br><span class="line">consumer.subscribe(<span class="string">&quot;TOPIC&quot;</span>, <span class="string">&quot;TAGA || TAGB || TAGC&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用SQL表达式筛选消息——通过消息的属性运算，如下所示</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">| message  |</span><br><span class="line">|----------|  a &gt; 5 AND b = <span class="emphasis">&#x27;abc&#x27;</span></span><br><span class="line">| a = 10   |  --------------------&gt; Gotten</span><br><span class="line">| b = <span class="emphasis">&#x27;abc&#x27;</span>|</span><br><span class="line">| c = true |</span><br><span class="line">------------</span><br><span class="line">------------</span><br><span class="line">| message  |</span><br><span class="line">|----------|   a &gt; 5 AND b = <span class="emphasis">&#x27;abc&#x27;</span></span><br><span class="line">| a = 1    |  --------------------&gt; Missed</span><br><span class="line">| b = <span class="emphasis">&#x27;abc&#x27;</span>|</span><br><span class="line">| c = true |</span><br><span class="line">------------</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="SQL基本语法"><a href="#SQL基本语法" class="headerlink" title="SQL基本语法"></a>SQL基本语法</h4><ul>
<li><p>数值比较，比如：**&gt;，&gt;=，&lt;，&lt;=，BETWEEN，=；**</p>
</li>
<li><p>字符比较，比如：**=，&lt;&gt;，IN；**</p>
</li>
<li><p><strong>IS NULL</strong> 或者 <strong>IS NOT NULL；</strong></p>
</li>
<li><p>逻辑符号 <strong>AND，OR，NOT；</strong></p>
</li>
<li><p>常量类型：</p>
<ul>
<li>数值，比如：<strong>123，3.1415；</strong></li>
<li>字符，比如：**’abc’，必须用单引号包裹起来；**</li>
<li><strong>NULL</strong>，特殊的常量</li>
<li>布尔值，<strong>TRUE</strong> 或 <strong>FALSE</strong></li>
</ul>
</li>
<li><p>只有使用push模式的消费者才能用使用SQL92标准的sql语句，接口如下：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(finalString topic, <span class="keyword">final</span> MessageSelector messageSelector)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="消息生产者"><a href="#消息生产者" class="headerlink" title="消息生产者"></a>消息生产者</h4><ul>
<li><p>通过<code>putUserProperty</code>来设置消息的属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">producer.start();</span><br><span class="line">Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">   tag,</span><br><span class="line">   (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 设置一些属性</span></span><br><span class="line">msg.putUserProperty(<span class="string">&quot;a&quot;</span>, String.valueOf(i));</span><br><span class="line">SendResult sendResult = producer.send(msg);</span><br><span class="line"></span><br><span class="line">producer.shutdown();</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="消息消费者"><a href="#消息消费者" class="headerlink" title="消息消费者"></a>消息消费者</h4><ul>
<li><p>用MessageSelector.bySql使用sql筛选消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">&quot;please_rename_unique_group_name_4&quot;</span>);</span><br><span class="line"><span class="comment">// 只有订阅的消息有这个属性a, a &gt;=0 and a &lt;= 3</span></span><br><span class="line">consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, MessageSelector.bySql(<span class="string">&quot;a between 0 and 3&quot;</span>);</span><br><span class="line">consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line">consumer.start();</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h3><ul>
<li><p>流程：正常事务消息的发送及提交、事务消息的补偿</p>
<img src="/2023/04/15/RocketMQ/事务消息.png" style="zoom:67%;">

<ul>
<li><p>事务消息发送及提交</p>
<p>(1) 发送消息（half消息）</p>
<p>(2) 服务端响应消息写入结果</p>
<p>(3) 根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）</p>
<p>(4) 根据本地事务状态执行Commit或者Rollback（Commit操作生成消息索引，消息对消费者可见）</p>
</li>
<li><p>事务补偿：用于解决消息Commit或者Rollback发生超时或者失败的情况</p>
<p>(1) 对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次“回查”</p>
<p>(2) Producer收到回查消息，检查回查消息对应的本地事务的状态</p>
<p>(3) 根据本地事务状态，重新Commit或者Rollback</p>
</li>
</ul>
</li>
<li><p>事务消息状态：提交状态、回滚状态、中间状态</p>
<ul>
<li>TransactionStatus.CommitTransaction: 提交事务，允许消费者消费此消息</li>
<li>TransactionStatus.RollbackTransaction: 回滚事务，代表该消息将被删除，不允许被消费</li>
<li>TransactionStatus.Unknown: 中间状态，代表需要检查消息队列来确定状态</li>
</ul>
</li>
</ul>
<h4 id="事务性生产者"><a href="#事务性生产者" class="headerlink" title="事务性生产者"></a>事务性生产者</h4><ul>
<li>使用 <code>TransactionMQProducer</code>类创建生产者，并指定唯一的 <code>ProducerGroup</code>，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需要根据执行结果对消息队列进行回复。回传的事务状态如上所述</li>
<li>当发送半消息成功时，使用 <code>executeLocalTransaction</code> 方法来执行本地事务，该方法返回的三个事务状态之一。<code>checkLocalTranscation</code> 方法用于检查本地事务状态，并回应消息队列的检查请求，返回三个事务状态之一</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//创建事务监听器</span></span><br><span class="line">        TransactionListener transactionListener = <span class="keyword">new</span> TransactionListenerImpl();</span><br><span class="line">        <span class="comment">//创建消息生产者</span></span><br><span class="line">        TransactionMQProducer producer = <span class="keyword">new</span> TransactionMQProducer(<span class="string">&quot;group6&quot;</span>);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;192.168.25.135:9876;192.168.25.138:9876&quot;</span>);</span><br><span class="line"></span><br><span class="line">        producer.setTransactionListener(transactionListener);</span><br><span class="line">        producer.start();</span><br><span class="line">        String[] tags = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;TagB&quot;</span>, <span class="string">&quot;TagC&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;TransactionTopic&quot;</span>, tags[i % tags.length], <span class="string">&quot;KEY&quot;</span> + i,</span><br><span class="line">                        (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                SendResult sendResult = producer.sendMessageInTransaction(msg, <span class="keyword">null</span>);</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MQClientException | UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//producer.shutdown();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionListenerImpl</span> <span class="keyword">implements</span> <span class="title">TransactionListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行本地事务&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equals(<span class="string">&quot;TagA&quot;</span>, msg.getTags())) &#123;</span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.equals(<span class="string">&quot;TagB&quot;</span>, msg.getTags())) &#123;</span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MQ检查消息Tag【&quot;</span>+msg.getTags()+<span class="string">&quot;】的本地事务执行结果&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><ol>
<li>事务消息不支持延时消息和批量消息</li>
<li>为了避免单个消息被检查太多次而导致半队列消息累积，默认将单个消息的检查次数限制为 15 次。用户通过 Broker 配置文件的 <code>transactionCheckMax</code>参数修改此限制。如果检查某条消息超过 N 次（ N = <code>transactionCheckMax</code> ） ，Broker 将丢弃此消息，并在默认情况下同时打印错误日志，可以重写 <code>AbstractTransactionCheckListener</code> 类来修改这个行为</li>
<li>事务消息在 Broker 配置文件中参数 transactionMsgTimeout 时间长度之后被检查。用户可以通过设置用户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 <code>transactionMsgTimeout</code> 参数</li>
<li>事务性消息可能不止一次被检查或消费</li>
<li>如果希望确保事务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制</li>
<li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享</li>
<li>事务消息允许反向查询、MQ服务器能通过生产者 ID 查询到消费者</li>
</ol>
<h2 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h2><h3 id="消息存储"><a href="#消息存储" class="headerlink" title="消息存储"></a>消息存储</h3><img src="/2023/04/15/RocketMQ/消息存储方式.png" style="zoom: 67%;">

<p>分布式队列要求高可靠性，数据要持久化存储</p>
<ol>
<li>producer发送消息</li>
<li>MQ收到消息，将消息进行持久化，存储中新增一条记录</li>
<li>返回ACK给producer</li>
<li>MQ push 消息给对应的consumer，等待consumer返回ACK</li>
<li>MQ在指定时间内收到consumer的ACK，从存储中删除消息，否则认为消息消费失败，尝试重新push消息</li>
</ol>
<h4 id="存储介质"><a href="#存储介质" class="headerlink" title="存储介质"></a>存储介质</h4><ul>
<li>关系型数据库：ActiveMQ（默认采用的KahaDB做消息存储）可通过JDBC持久化消息</li>
</ul>
<ul>
<li>文件系统：RocketMQ/Kafka/RabbitMQ 均是刷盘至所部署虚拟机/物理机的文件系统来持久化（分为异步刷盘和同步刷盘）——除非部署MQ机器本身或是本地磁盘挂了，否则一般是不会出现无法持久化的故障问题，且刷盘速度更快</li>
</ul>
<h4 id="消息的存储和发送"><a href="#消息的存储和发送" class="headerlink" title="消息的存储和发送"></a>消息的存储和发送</h4><h5 id="1）消息存储"><a href="#1）消息存储" class="headerlink" title="1）消息存储"></a>1）消息存储</h5><ul>
<li>RocketMQ的消息为顺序写，保证消息存储的速度（顺序写速度可达到600MB/s， 超过一般网卡的传输速度）</li>
</ul>
<h5 id="2）消息发送"><a href="#2）消息发送" class="headerlink" title="2）消息发送"></a>2）消息发送</h5><ul>
<li><p>文件操作、网络操作需要涉及用户态和内核态的切换，需要数据复制（以服务器发送文件到客户端为例）</p>
<ul>
<li>read：读取本地文件内容<ul>
<li>从磁盘复制数据到内核态内存</li>
<li>从内核态内存复制到用户态内存</li>
</ul>
</li>
<li>write：将读取的内容通过网络发送<ul>
<li>从用户态内存复制到网络驱动的内核态内存</li>
<li>从网络驱动的内核态内存复制到网卡进行传输</li>
</ul>
</li>
</ul>
<p><img src="/2023/04/15/RocketMQ/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%92%8C%E7%BD%91%E7%BB%9C%E6%93%8D%E4%BD%9C.png"></p>
</li>
<li><p>通过使用mmap省去向用户态的内存复制——Java中通过MappedByteBuffer实现（零拷贝）</p>
<ul>
<li>一次只能映射1.5~2G 的文件至用户态的虚拟内存</li>
<li>RocketMQ默认设置单个CommitLog日志数据文件为1G</li>
</ul>
</li>
</ul>
<h4 id="消息存储结构"><a href="#消息存储结构" class="headerlink" title="消息存储结构"></a>消息存储结构</h4><ul>
<li>存储由ConsumeQueue和CommitLog配合完成<ul>
<li>物理存储文件：CommitLog</li>
<li>消息的逻辑队列：ConsumeQueue（类似数据库的索引文件，存储指向物理存储的地址），每个Topic下的每个Message Queue都有一个ConsumeQueue</li>
</ul>
</li>
<li>IndexFile：一种通过key或时间区间来查询消息的方法，不影响发送与消费消息的主流程</li>
</ul>
<img src="/2023/04/15/RocketMQ/消息存储结构.png" style="zoom:67%;">

<h4 id="刷盘机制"><a href="#刷盘机制" class="headerlink" title="刷盘机制"></a>刷盘机制</h4><ul>
<li>同步刷盘、异步刷盘——通过Broker配置文件的 flushDiskType 参数设置（SYNC_FLUSH、ASYNC_FLUSH）</li>
</ul>
<img src="/2023/04/15/RocketMQ/同步刷盘和异步刷盘.png" style="zoom:67%;">

<h5 id="1）同步刷盘"><a href="#1）同步刷盘" class="headerlink" title="1）同步刷盘"></a>1）同步刷盘</h5><ul>
<li>在返回写成功状态时，消息已经被写入磁盘</li>
<li>消息写入内存的PAGE CACHE后立刻通知刷盘线程刷盘， 刷盘完成后唤醒等待的线程，返回消息写成功</li>
</ul>
<h5 id="2）异步刷盘"><a href="#2）异步刷盘" class="headerlink" title="2）异步刷盘"></a>2）异步刷盘</h5><ul>
<li>返回写成功状态时，消息可能只是被写入了内存的PAGE CACHE</li>
<li>当内存里的消息量积累到一定程度时，统一触发写磁盘</li>
</ul>
<h3 id="高可用性机制"><a href="#高可用性机制" class="headerlink" title="高可用性机制"></a>高可用性机制</h3><img src="/2023/04/15/RocketMQ/RocketMQ角色-1682761941955.jpg" style="zoom: 50%;">

<h4 id="NameServer高可用"><a href="#NameServer高可用" class="headerlink" title="NameServer高可用"></a>NameServer高可用</h4><ul>
<li>NameServer 节点是无状态的，各个节点直接的数据一致</li>
<li>存在多个 NameServer 节点的情况下，部分 NameServer 不可用也可以保证 MQ 服务正常运行</li>
</ul>
<h4 id="Broker高可用"><a href="#Broker高可用" class="headerlink" title="Broker高可用"></a>Broker高可用</h4><ul>
<li>RocketMQ分布式集群是通过Master-Slave实现高可用<ul>
<li>Broker配置文件参数 brokerId 为0表明是Master，大于0表明是 Slave</li>
<li>Broker配置文件参数 brokerRole 说明是Master还是Slave</li>
</ul>
</li>
<li>Master 的 Broker 支持读和写，Slave仅支持读</li>
</ul>
<h4 id="消息消费高可用"><a href="#消息消费高可用" class="headerlink" title="消息消费高可用"></a>消息消费高可用</h4><ul>
<li>Consumer不需要设置读Master还是Slave，Master不可用时Consumer自动切换到读Slave</li>
</ul>
<h4 id="消息发送高可用"><a href="#消息发送高可用" class="headerlink" title="消息发送高可用"></a>消息发送高可用</h4><ul>
<li>创建Topic时，把该Topic的多个MQ创建在多个Broker组上（相同Broker名称，不同 brokerId 的机器组成一个Broker组）</li>
<li>一个Broker组的Master不可用，其他组的Master仍然可用，Producer仍然可以发送消息</li>
<li>目前不支持Slave转Master，要手动停止Slave角色的Broker，更改配置文件，用新的配置文件启动Broker。</li>
</ul>
<img src="/2023/04/15/RocketMQ/消息发送高可用设计.jpg" style="zoom:80%;">

<ul>
<li>rocketmq采用Broker故障延迟机制来规避故障的broker（<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903813803966478">深度解析RocketMQ消息发送的高可用设计</a>）</li>
</ul>
<h3 id="消息主从复制"><a href="#消息主从复制" class="headerlink" title="消息主从复制"></a>消息主从复制</h3><ul>
<li>消息从Master复制到Slave上，同步、异步——通过Broker配置文件的brokerRole参数设置，可以设置成ASYNC_MASTER、 SYNC_MASTER、SLAVE三个值中的一个</li>
</ul>
<h4 id="1）同步复制"><a href="#1）同步复制" class="headerlink" title="1）同步复制"></a>1）同步复制</h4><ul>
<li>同步复制：Master和Slave均写成功后才反馈给客户端写成功</li>
<li>优点：Master出故障， Slave上有全部的备份数据，容易恢复；缺点：增大数据写入延迟，降低系统吞吐量</li>
</ul>
<h4 id="2）异步复制"><a href="#2）异步复制" class="headerlink" title="2）异步复制"></a>2）异步复制</h4><ul>
<li>异步复制：只要Master写成功即反馈给客户端写成功——吞吐量高，但有可能会丢数</li>
</ul>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><h4 id="Producer负载均衡"><a href="#Producer负载均衡" class="headerlink" title="Producer负载均衡"></a>Producer负载均衡</h4><ul>
<li>每个Producer实例会轮询所有的message queue发送，以达到让消息平均落在不同的queue上。queue可以散落在不同的broker，消息就发送到不同的broker</li>
</ul>
<img src="/2023/04/15/RocketMQ/producer负载均衡.png" style="zoom:67%;">

<h4 id="Consumer负载均衡"><a href="#Consumer负载均衡" class="headerlink" title="Consumer负载均衡"></a>Consumer负载均衡</h4><h5 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h5><ul>
<li>集群消费模式下，每条消息投递到订阅该topic的Consumer Group下的一个实例即可。RocketMQ采用主动拉取的方式消费消息，拉取的时候需要明确指定拉取哪一条message queue</li>
<li>当实例的数量有变更，会触发一次所有实例的负载均衡——按照queue的数量和实例的数量平均分配queue给每个实例，默认的分配算法是AllocateMessageQueueAveragely</li>
</ul>
<img src="/2023/04/15/RocketMQ/consumer负载均衡.png" style="zoom:50%;">

<ul>
<li>另一种平均算法是AllocateMessageQueueAveragelyByCircle，以环状轮流分queue</li>
</ul>
<img src="/2023/04/15/RocketMQ/consumer负载均衡2.png" style="zoom:50%;">

<ul>
<li><p><strong>集群模式下，queue只允许分配一个实例</strong>，如果多个实例同时消费一个queue的消息，由于拉取哪些消息是consumer主动控制的，会导致同一个消息在不同的实例下被消费多次</p>
</li>
<li><p>增加consumer实例去分摊queue的消费，可以起到水平扩展的消费能力的作用</p>
</li>
<li><p>需要让queue的总数量大于等于consumer的数量</p>
</li>
</ul>
<h5 id="广播模式"><a href="#广播模式" class="headerlink" title="广播模式"></a>广播模式</h5><ul>
<li>广播模式下一条消息需要投递到一个消费组下面所有的消费者实例</li>
<li>所有consumer都分到所有的queue</li>
</ul>
<img src="/2023/04/15/RocketMQ/consumer负载均衡3.png" style="zoom:67%;">

<h3 id="消息重试"><a href="#消息重试" class="headerlink" title="消息重试"></a>消息重试</h3><h4 id="顺序消息的重试"><a href="#顺序消息的重试" class="headerlink" title="顺序消息的重试"></a>顺序消息的重试</h4><ul>
<li>消费者消费顺序消息失败后，RocketMQ不断进行消息重试（每次间隔 1 秒）——会出现消费阻塞</li>
</ul>
<h4 id="无序消息的重试"><a href="#无序消息的重试" class="headerlink" title="无序消息的重试"></a>无序消息的重试</h4><ul>
<li>无序消息（普通、定时、延时、事务消息）消费失败时，可以通过设置返回状态实现消息重试</li>
<li>无序消息的重试只在集群消费生效；广播消费不提供失败重试</li>
</ul>
<h5 id="重试次数"><a href="#重试次数" class="headerlink" title="重试次数"></a>重试次数</h5><ul>
<li>RocketMQ 默认允许每条消息最多重试 16 次（消息的 Message ID 不变）</li>
<li>消息重试 16 次后仍然失败，消息将不再投递</li>
</ul>
<table>
<thead>
<tr>
<th align="center">第几次重试</th>
<th align="center">与上次重试的间隔时间</th>
<th align="center">第几次重试</th>
<th align="center">与上次重试的间隔时间</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">10 秒</td>
<td align="center">9</td>
<td align="center">7 分钟</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">30 秒</td>
<td align="center">10</td>
<td align="center">8 分钟</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">1 分钟</td>
<td align="center">11</td>
<td align="center">9 分钟</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">2 分钟</td>
<td align="center">12</td>
<td align="center">10 分钟</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">3 分钟</td>
<td align="center">13</td>
<td align="center">20 分钟</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">4 分钟</td>
<td align="center">14</td>
<td align="center">30 分钟</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">5 分钟</td>
<td align="center">15</td>
<td align="center">1 小时</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">6 分钟</td>
<td align="center">16</td>
<td align="center">2 小时</td>
</tr>
</tbody></table>
<h5 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h5><ul>
<li>集群消费方式下，需要在消息监听器接口的实现中明确配置：<ul>
<li>返回 Action.ReconsumeLater （推荐）</li>
<li>返回 Null</li>
<li>抛出异常</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//处理消息</span></span><br><span class="line">        doConsumeMessage(message);</span><br><span class="line">        <span class="comment">//方式1：返回 Action.ReconsumeLater，消息将重试</span></span><br><span class="line">        <span class="keyword">return</span> Action.ReconsumeLater;</span><br><span class="line">        <span class="comment">//方式2：返回 null，消息将重试</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//方式3：直接抛出异常， 消息将重试</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Consumer Message exceotion&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不重试消息，需要捕获消费逻辑中可能抛出的异常，返回 Action.CommitMessage</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doConsumeMessage(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">//捕获消费逻辑中的所有异常，并返回 Action.CommitMessage;</span></span><br><span class="line">            <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//消息处理正常，直接返回 Action.CommitMessage;</span></span><br><span class="line">        <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以自定义消息最大重试次数</p>
<ul>
<li><p>最大重试次数小于等于 16 次，重试时间如上表所述</p>
</li>
<li><p>最大重试次数大于 16 次，超过 16 次的重试时间间隔为每次 2 小时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line"><span class="comment">//配置对应 Group ID 的最大消息重试次数为 20 次</span></span><br><span class="line">properties.put(PropertyKeyConst.MaxReconsumeTimes,<span class="string">&quot;20&quot;</span>);</span><br><span class="line">Consumer consumer =ONSFactory.createConsumer(properties);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li>配置采用覆盖的方式生效，最后启动的 Consumer 实例会覆盖之前的启动实例的配置</li>
</ul>
<ul>
<li><p>消费者可获取消息的重试次数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取消息的重试次数</span></span><br><span class="line">        message.getReconsumeTimes();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h3><ul>
<li><p>消费失败的消息（死信消息（Dead-Letter Message）），RocketMQ 不会立刻将消息丢弃，而是发送到该消费者对应的特殊队列（死信队列（Dead-Letter Queue））</p>
</li>
<li><p>死信不会再被正常消费吗，三天后自动删除</p>
</li>
</ul>
<ul>
<li>一个死信队列对应一个 Group ID， 而不是对应单个消费者实例，且包含其产生的所有死信消息。一个 Group ID 未产生死信消息，RocketMQ 不会为其创建相应的死信队列</li>
</ul>
<ul>
<li>可以在 RocketMQ 控制台重新发送该消息</li>
</ul>
<h3 id="消费幂等"><a href="#消费幂等" class="headerlink" title="消费幂等"></a>消费幂等</h3><ul>
<li><p>消息有可能会出现重复</p>
<ul>
<li><p>发送/消费时消息重复：消息已被成功发送到服务端并完成持久化/消息已经成功被消费，但因为网络问题没有应答，此时重复发送消息</p>
</li>
<li><p>负载均衡时消息重复：RocketMQ 的 Broker 或客户端重启、扩容或缩容时，会触发 Rebalance，消费者可能会收到重复消息</p>
</li>
</ul>
</li>
<li><p>Message ID 有可能出现冲突（重复），因此不建议以 Message ID 作为处理依据。 最好以业务唯一标识作为幂等处理的依据（可以通过消息 Key 设置）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Message message = <span class="keyword">new</span> Message();</span><br><span class="line">message.setKey(<span class="string">&quot;ORDERID_100&quot;</span>);</span><br><span class="line">SendResult sendResult = producer.send(message);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 幂等处理</span></span><br><span class="line">consumer.subscribe(<span class="string">&quot;ons_test&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="keyword">new</span> MessageListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        String key = message.getKey()</span><br><span class="line">        <span class="comment">// 根据业务唯一标识的 key 做幂等处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\05\03\Dubbo-1\" rel="bookmark">Dubbo</a></div>
        <div class="popular-posts-excerpt"><p><p>Dubbo基本概念和使用</p></p></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\05\03\Dubbo-2\" rel="bookmark">RocketMQ+Dubbo案例</a></div>
        <div class="popular-posts-excerpt"><p><p>RocketMQ+Dubbo+Zookeeper，实现下单和支付业务</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/xvmingyuan/shop">xvmingyuan/shop: SpringBoot Dubbo RocketMQ订单支付系统 (github.com)</a></p></p></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\04\30\RocketMQ源码分析\" rel="bookmark">RocketMQ源码分析</a></div>
        <div class="popular-posts-excerpt"><p><p>RocketMQ源码阅读</p></p></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\09\15\TDDL\" rel="bookmark">TDDL中间件</a></div>
        <div class="popular-posts-excerpt"><p><p>TDDL 分布式数据库中间件</p></p></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\10\01\Docker\" rel="bookmark">Docker 核心概念</a></div>
        <div class="popular-posts-excerpt"><p><p>Docker 核心概念总结</p></p></div>
    </li>
  </ul>

        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Thomas-Li 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Thomas-Li 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Thomas-Li
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/" title="RocketMQ">https://thomas-li-sjtu.github.io/2023/04/15/RocketMQ/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <div>
      
        
      
      </div>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
              <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> 分布式</a>
              <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"><i class="fa fa-tag"></i> 中间件</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/12/24/spring-8/" rel="prev" title="SpringBoot（3） 原理篇">
      <i class="fa fa-chevron-left"></i> SpringBoot（3） 原理篇
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/04/28/git/" rel="next" title="Git指令备忘">
      Git指令备忘 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      <!-- require APlayer -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
      <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
      <!-- require MetingJS-->
      <script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script> 
      <!--������-->   
      <meting-js
        server="netease"
        id="2655164600"
        type="playlist" 
        mini="false"
        fixed="false"
        list-folded="true"
        autoplay="false"
        volume="0.4"
        theme="#FADFA3"
        order="random"
        loop="all"
        preload="auto"
        mutex="true">
      </meting-js>

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>
      
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#MQ"><span class="nav-number">1.</span> <span class="nav-text">MQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%B5%81MQ"><span class="nav-number">1.1.</span> <span class="nav-text">主流MQ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">单节点、集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9"><span class="nav-number">2.1.</span> <span class="nav-text">单节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4"><span class="nav-number">2.2.</span> <span class="nav-text">集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="nav-number">2.2.1.</span> <span class="nav-text">集群角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E6%96%B9%E5%BC%8F"><span class="nav-number">2.2.2.</span> <span class="nav-text">搭建方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Broker%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.3.</span> <span class="nav-text">Broker配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89master1"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">1）master1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89slave2"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">2）slave2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%EF%BC%89master2"><span class="nav-number">2.2.3.3.</span> <span class="nav-text">3）master2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4%EF%BC%89slave1"><span class="nav-number">2.2.3.4.</span> <span class="nav-text">4）slave1</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mqadmin%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="nav-number">2.3.</span> <span class="nav-text">mqadmin管理工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89Topic%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.1.</span> <span class="nav-text">1）Topic相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E9%9B%86%E7%BE%A4%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.2.</span> <span class="nav-text">2）集群相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89Broker%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.3.</span> <span class="nav-text">3）Broker相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%EF%BC%89%E6%B6%88%E6%81%AF%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.4.</span> <span class="nav-text">4）消息相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%EF%BC%89%E6%B6%88%E8%B4%B9%E8%80%85%E3%80%81%E6%B6%88%E8%B4%B9%E7%BB%84%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.5.</span> <span class="nav-text">5）消费者、消费组相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%EF%BC%89%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.6.</span> <span class="nav-text">6）连接相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7%EF%BC%89NameServer%E7%9B%B8%E5%85%B3"><span class="nav-number">2.3.7.</span> <span class="nav-text">7）NameServer相关</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%B6%88%E8%B4%B9%E8%8C%83%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">消息发送消费范例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%8C%83%E4%BE%8B"><span class="nav-number">3.1.</span> <span class="nav-text">基本范例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="nav-number">3.1.1.</span> <span class="nav-text">消息发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9"><span class="nav-number">3.1.2.</span> <span class="nav-text">消息消费</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="nav-number">3.2.</span> <span class="nav-text">顺序消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="nav-number">3.3.</span> <span class="nav-text">延时消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%B6%88%E6%81%AF"><span class="nav-number">3.4.</span> <span class="nav-text">批量消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E6%B6%88%E6%81%AF"><span class="nav-number">3.5.</span> <span class="nav-text">过滤消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-number">3.5.1.</span> <span class="nav-text">SQL基本语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">3.5.2.</span> <span class="nav-text">消息生产者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">3.5.3.</span> <span class="nav-text">消息消费者</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="nav-number">3.6.</span> <span class="nav-text">事务消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%80%A7%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">3.6.1.</span> <span class="nav-text">事务性生产者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%90%E5%88%B6"><span class="nav-number">3.6.2.</span> <span class="nav-text">限制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">4.</span> <span class="nav-text">高级功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="nav-number">4.1.</span> <span class="nav-text">消息存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8"><span class="nav-number">4.1.1.</span> <span class="nav-text">存储介质</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E7%9A%84%E5%AD%98%E5%82%A8%E5%92%8C%E5%8F%91%E9%80%81"><span class="nav-number">4.1.2.</span> <span class="nav-text">消息的存储和发送</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">1）消息存储</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">2）消息发送</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.3.</span> <span class="nav-text">消息存储结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%B7%E7%9B%98%E6%9C%BA%E5%88%B6"><span class="nav-number">4.1.4.</span> <span class="nav-text">刷盘机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E5%90%8C%E6%AD%A5%E5%88%B7%E7%9B%98"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">1）同步刷盘</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E5%BC%82%E6%AD%A5%E5%88%B7%E7%9B%98"><span class="nav-number">4.1.4.2.</span> <span class="nav-text">2）异步刷盘</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E6%9C%BA%E5%88%B6"><span class="nav-number">4.2.</span> <span class="nav-text">高可用性机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NameServer%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.2.1.</span> <span class="nav-text">NameServer高可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Broker%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.2.2.</span> <span class="nav-text">Broker高可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.2.3.</span> <span class="nav-text">消息消费高可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.2.4.</span> <span class="nav-text">消息发送高可用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">4.3.</span> <span class="nav-text">消息主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">4.3.1.</span> <span class="nav-text">1）同步复制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">4.3.2.</span> <span class="nav-text">2）异步复制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">4.4.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Producer%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">4.4.1.</span> <span class="nav-text">Producer负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Consumer%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">4.4.2.</span> <span class="nav-text">Consumer负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">集群模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B9%BF%E6%92%AD%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.4.2.2.</span> <span class="nav-text">广播模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95"><span class="nav-number">4.5.</span> <span class="nav-text">消息重试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF%E7%9A%84%E9%87%8D%E8%AF%95"><span class="nav-number">4.5.1.</span> <span class="nav-text">顺序消息的重试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A0%E5%BA%8F%E6%B6%88%E6%81%AF%E7%9A%84%E9%87%8D%E8%AF%95"><span class="nav-number">4.5.2.</span> <span class="nav-text">无序消息的重试</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0"><span class="nav-number">4.5.2.1.</span> <span class="nav-text">重试次数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="nav-number">4.5.2.2.</span> <span class="nav-text">配置方式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="nav-number">4.6.</span> <span class="nav-text">死信队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E5%B9%82%E7%AD%89"><span class="nav-number">4.7.</span> <span class="nav-text">消费幂等</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Thomas-Li"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Thomas-Li</p>
  <div class="site-description" itemprop="description">Stay hungry. Stay foolish.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">185</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/thomas-li-sjtu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thomas-li-sjtu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/thomasli2017" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;thomasli2017" rel="noopener" target="_blank"><i class="fa fa-csdn fa-fw"></i>CSDN</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://rooki3ray.github.io/" title="https:&#x2F;&#x2F;rooki3ray.github.io&#x2F;" rel="noopener" target="_blank">rooki3ray</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://entropy2333.github.io/" title="https:&#x2F;&#x2F;entropy2333.github.io&#x2F;" rel="noopener" target="_blank">entropy2333</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://schenk75.github.io/" title="https:&#x2F;&#x2F;schenk75.github.io&#x2F;" rel="noopener" target="_blank">Schenk75</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ainevsia.github.io/" title="https:&#x2F;&#x2F;ainevsia.github.io&#x2F;" rel="noopener" target="_blank">Ainevsia</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thomas-Li</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25:09</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fa fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fa fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button" onclick="moonMenuClick()">
    <svg class="moon-menu-svg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
      <g class="moon-menu-points">
        <circle class="moon-menu-point" r=".2rem" cx="0" cy="-.8rem"></circle>
        <circle class="moon-menu-point" r=".2rem"></circle>
        <circle class="moon-menu-point" r=".2rem" cx="0" cy=".8rem"></circle>
      </g>
    </svg>
    <div class="moon-menu-icon">
    </div>
    <div class="moon-menu-text">
    </div>
  </div>
</div>
<script src="/js/injector.js"></script>

  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
</body>
</html>
